{"version":3,"file":"cursor.js","sourceRoot":"","sources":["../../../src/components/editor/cursor.ts"],"names":[],"mappings":"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","sourcesContent":["import { FlowDocument } from \"@chaincode/flow-document\";\r\nimport { Dom, Template } from \"@prague/flow-util\";\r\nimport { LocalReference } from \"@prague/merge-tree\";\r\nimport { debug } from \"../../debug\";\r\nimport * as styles from \"./index.css\";\r\n\r\nconst template = new Template({\r\n    tag: \"span\",\r\n    props: { className: styles.cursorOverlay },\r\n    children: [\r\n        { tag: \"span\", ref: \"highlights\", props: { className: styles.cursorHighlightRoot }},\r\n        { tag: \"span\", ref: \"cursor\", props: { className: styles.cursor }},\r\n    ],\r\n});\r\n\r\nexport class Cursor {\r\n\r\n    public get selectionStart() { return this.doc.localRefToPosition(this.startRef); }\r\n\r\n    public get position() { return this.doc.localRefToPosition(this.endRef); }\r\n\r\n    public get bounds() { return this.cursorBounds; }\r\n\r\n    public readonly root: HTMLElement;\r\n    private startRef: LocalReference;\r\n    private endRef: LocalReference;\r\n\r\n    private startContainer?: Node;\r\n    private relativeStartOffset = NaN;\r\n\r\n    private endContainer?: Node;\r\n    private relativeEndOffset = NaN;\r\n    private cursorBounds?: ClientRect;\r\n\r\n    private readonly domRange = document.createRange();\r\n    private readonly highlightRootElement: Element;\r\n    private readonly cursorElement: HTMLElement;\r\n\r\n    constructor(private readonly doc: FlowDocument) {\r\n        this.root = template.clone() as HTMLElement;\r\n        this.highlightRootElement = template.get(this.root, \"highlights\");\r\n        this.cursorElement = template.get(this.root, \"cursor\") as HTMLElement;\r\n\r\n        this.startRef = doc.addLocalRef(0);\r\n        this.endRef = doc.addLocalRef(0);\r\n    }\r\n\r\n    public moveTo(position: number, extendSelection: boolean) {\r\n        this.setPosition(position);\r\n        if (!extendSelection) {\r\n            this.setSelectionStart(position);\r\n        }\r\n    }\r\n\r\n    public moveBy(delta: number, extendSelection: boolean) {\r\n        this.moveTo(this.position + delta, extendSelection);\r\n    }\r\n\r\n    public getTracked() {\r\n        return [\r\n            { position: this.position, callback: this.updateDomRangeEnd },\r\n            { position: this.selectionStart, callback: this.updateDomRangeStart },\r\n        ];\r\n    }\r\n\r\n    public show() {\r\n        debug(\"show cursor\");\r\n        this.root.style.visibility = \"inherit\";\r\n    }\r\n\r\n    public hide() {\r\n        debug(\"hide cursor\");\r\n        this.root.style.visibility = \"hidden\";\r\n    }\r\n\r\n    public readonly render = () => {\r\n        return this.root;\r\n    }\r\n\r\n    private clampPosition(position: number) {\r\n        return Math.min(Math.max(position, 0), this.doc.length - 1);\r\n    }\r\n\r\n    private addLocalRef(position: number) {\r\n        return this.doc.addLocalRef(this.clampPosition(position));\r\n    }\r\n    private setSelectionStart(newStart: number) {\r\n        this.doc.removeLocalRef(this.startRef);\r\n        this.startRef = this.addLocalRef(newStart);\r\n    }\r\n    private setPosition(newEnd: number) {\r\n        this.doc.removeLocalRef(this.endRef);\r\n        this.endRef = this.addLocalRef(newEnd);\r\n    }\r\n\r\n    private clampToText(container: Node, position: number) {\r\n        return Math.max(0, Math.min(position, container.textContent!.length));\r\n    }\r\n\r\n    private setRangeStart(container: Node, position: number) {\r\n        this.domRange.setStart(container, this.clampToText(container, position));\r\n    }\r\n\r\n    private setRangeEnd(container: Node, position: number) {\r\n        this.domRange.setEnd(container, this.clampToText(container, position));\r\n    }\r\n\r\n    /**\r\n     * Returns the top/left offset of nearest ancestor that is a CSS containing block, used to\r\n     * adjust absolute the x/y position of the caret/highlight.\r\n     */\r\n    private getOffset(): { top: number, left: number } {\r\n        // Note: Could generalize by walking parentElement chain and probing style properties.\r\n        return this.root.offsetParent!.getBoundingClientRect();\r\n    }\r\n\r\n    private updateSelection() {\r\n        // tslint:disable-next-line:no-inner-html\r\n        this.highlightRootElement.innerHTML = \"\";\r\n\r\n        if (!this.startContainer || !this.endContainer) {\r\n            throw new Error();\r\n        }\r\n\r\n        if (this.position > this.selectionStart) {\r\n            this.setRangeStart(this.startContainer, this.relativeStartOffset);\r\n            this.setRangeEnd(this.endContainer, this.relativeEndOffset);\r\n        } else {\r\n            this.setRangeEnd(this.startContainer, this.relativeStartOffset);\r\n            this.setRangeStart(this.endContainer, this.relativeEndOffset);\r\n        }\r\n\r\n        const selection = window.getSelection();\r\n        selection.removeAllRanges();\r\n        selection.addRange(this.domRange);\r\n\r\n        // const offset = this.getOffset();\r\n        // for (const rect of this.domRange.getClientRects()) {\r\n        //     debug(`highlight: ${JSON.stringify(rect)}`);\r\n        //     const div = e({ tag: \"div\", props: { className: styles.highlightRect }});\r\n\r\n        //     div.style.top = `${rect.top - offset.top}px`;\r\n        //     div.style.left = `${rect.left - offset.left}px`;\r\n        //     div.style.width = `${rect.width}px`;\r\n        //     div.style.height = `${rect.height}px`;\r\n\r\n        //     this.highlightRootElement.appendChild(div);\r\n        // }\r\n    }\r\n\r\n    private getCursorBounds() {\r\n        if ((!this.endContainer)\r\n            || (this.relativeEndOffset < 0 || +Infinity < this.relativeEndOffset)\r\n        ) {\r\n            return undefined;\r\n        }\r\n\r\n        return Dom.getClientRect(this.endContainer, this.relativeEndOffset);\r\n    }\r\n\r\n    private updateCursor() {\r\n        // If the cursor position is currently within the windowed of rendered elements, display it at the\r\n        // appropriate location.\r\n        this.cursorBounds = this.getCursorBounds();\r\n        if (this.cursorBounds) {\r\n            const offset = this.getOffset();\r\n            debug(`cursor: (${this.cursorBounds.top} - ${offset.top} -> ${this.cursorBounds.top - offset.top},`);\r\n            debug(`        (${this.cursorBounds.left} - ${offset.left} -> ${this.cursorBounds.left - offset.left},`);\r\n            this.cursorElement.style.visibility = \"inherit\";\r\n            this.cursorElement.style.top = `${this.cursorBounds.top - offset.top}px`;\r\n            this.cursorElement.style.left = `${this.cursorBounds.left - offset.left}px`;\r\n            this.cursorElement.style.height = `${this.cursorBounds.height}px`;\r\n        } else {\r\n            // Otherwise hide it.\r\n            this.cursorElement.style.visibility = \"hidden\";\r\n        }\r\n    }\r\n\r\n    private readonly updateDomRangeStart = (node: Node, nodeOffset: number) => {\r\n        this.startContainer = node;\r\n        this.relativeStartOffset = nodeOffset;\r\n    }\r\n\r\n    private readonly updateDomRangeEnd = (node: Node, nodeOffset: number) => {\r\n        this.endContainer = node;\r\n        this.relativeEndOffset = nodeOffset;\r\n\r\n        this.updateCursor();\r\n        this.updateSelection();\r\n        this.restartBlinkAnimation();\r\n    }\r\n\r\n    private restartBlinkAnimation() {\r\n        // To restart the CSS blink animation, we reinsert the element it at it's current location.\r\n        // (See: https://css-tricks.com/restart-css-animation/).\r\n        if (this.cursorElement.parentNode) {\r\n            this.cursorElement.parentNode.insertBefore(this.cursorElement, this.cursorElement.previousSibling);\r\n        }\r\n    }\r\n}\r\n"]}